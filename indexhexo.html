<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Hexo</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Kategorien
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            Über
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/0725/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/0725/" itemprop="url">nodejs基础实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-25T22:22:06+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####名词解释</p>
<blockquote>
<p><strong>Node.js</strong></p>
</blockquote>
<p>是一个基于Chrome JavaScript运行时建立的平台， 用于方便地搭建响应速度快、易于扩展的网络应用，Node.js 使用事件驱动， 非阻塞I/O 模型而得以轻量和高效，非常适合在分布式设备上运行的数据密集型的实时应用。</p>
<blockquote>
<p><strong>NPM</strong></p>
</blockquote>
<p>一个NodeJS包管理和分发工具，它可以很快的找到特定服务要使用的包，进行下载、安装以及管理已经安装的包</p>
<blockquote>
<p><strong>Express</strong></p>
</blockquote>
<p>Express 是一个基于 Node.js 平台的极简、灵活的 web 应用开发框架</p>
<hr>
<p>####创建服务实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">var http = require(&apos;http&apos;);</div><div class="line">var port = 3000;</div><div class="line">var server = http.createServer(function(req,res) &#123;</div><div class="line">  res.statusCode = 200;</div><div class="line">  res.setHeader(&apos;Content-Type&apos;, &apos;text/plain&apos;);</div><div class="line">  res.end(&apos;Hello World\n&apos;);</div><div class="line">&#125;)</div><div class="line">server.listen(port,function() &#123;</div><div class="line">  console.log(&apos;Server running&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<hr>
<p>####NodeJS特点</p>
<ul>
<li><p>#####事件驱动<br>事件驱动模型三大要素：<br><strong>事件源</strong>：能够接收外部事件的源体。<br><strong>侦听器</strong>：能够接收事件源通知的对象。<br><strong>事件处理程序</strong>：用于处理事件的对象。</p>
</li>
<li><p>#####非阻塞I/O<br>阻塞调用是指调用结果返回之前，当前线程会被挂起。调用线程只有在得到结果之后才会返回。<br>非阻塞调用指在不能立刻得到结果之前，该调用不会阻塞当前线程。</p>
</li>
<li><p>#####事件轮询机制<br>一个事件轮询拥有下面三个组件<br><strong>事件队列</strong>：这是一个FIFO模型的队列，一方推入事件，另一方推出事件<br><strong>队列的读取轮询线程组件</strong>，也就是主角Event Loop，<br><strong>单独的线程池</strong>： 用来执行长任务（也就是threadpool，node底层，用C++写的，不会阻塞）<br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20170214/96ea1c33gy1fcl7bdc7pxj20f807k745.jpg" alt=""><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在NodeJS中，只有一个主线程（也就是前面说的单线程）来不断读取轮询（书中称为调用I/O观察者）队列中是否有事件。而对于读取文件，HTTP请求等比较容易堵塞的事件，就在这个单线程中执行肯定会造成堵塞，所以Event Loop会把这类型的事件交给底层的线程池执行，并给予线程池一个回调函数，当线程池操作完成这堵塞任务后，便把结果和回调函数一起再放入轮询队列中。当单线程从队列中不断读取事件，读取到这些堵塞的操作结果后，会将这些操作结果作为回调函数的输入参数，然后激活运行回调函数。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Node.js的这个单线程不只是负责读取队列事件，还会执行运行回调函数<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>优点</strong>：适合大量I/O计算<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>缺点</strong>：不适合密集的cpu计算</p>
</li>
</ul>
<hr>
<p>####NodeJS部分模块介绍</p>
<ul>
<li><p><strong>http</strong>    http是Node.JS从HTTP服务器获取相应内容的主要模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http.createServer()//返回一个新的Web服务器对象</div><div class="line">http.listen()//在指定的主机名和端口上建立连接</div></pre></td></tr></table></figure>
</li>
<li><p><strong>fs</strong> 处理文件系统的相关操作，例如读写文件，设置文件权限</p>
</li>
<li><p><strong>path</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">path.extname(&apos;index.html&apos;)</div><div class="line">// Returns: &apos;.html&apos;</div><div class="line">path.dirname(&apos;/foo/bar/baz/asdf/quux&apos;)</div><div class="line">// Returns: &apos;/foo/bar/baz/asdf&apos;</div></pre></td></tr></table></figure>
</li>
<li><p><strong>cluster模块</strong><br>产生更多的NodeJS进程来处理系统的加载，使用相同的源代码，监听相同的端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var cluster = require(&apos;cluster&apos;);</div><div class="line">var numCpus = require(&apos;os&apos;).cpus().length;</div><div class="line">cluster.isMaster//判断是否为主进程</div><div class="line">cluster.isWorker//判断是否为子进程</div><div class="line">cluster.worker.process.pid//获取进程pid</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>####NodeJS代理本地文件实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">var url  = require(&quot;url&quot;),</div><div class="line">     fs=require(&quot;fs&quot;),</div><div class="line">     http=require(&quot;http&quot;),</div><div class="line">     path = require(&quot;path&quot;);</div><div class="line">http.createServer(function (req, res) &#123;</div><div class="line">    var pathname=__dirname+url.parse(req.url).pathname;//__dirname使用该全局变量的绝对路径</div><div class="line">    fs.exists(pathname,function(exists)&#123;</div><div class="line">        if(exists)&#123;</div><div class="line">            switch(path.extname(pathname))&#123;</div><div class="line">                case &quot;.html&quot;:</div><div class="line">                    res.writeHead(200, &#123;&quot;Content-Type&quot;: &quot;text/html&quot;&#125;);</div><div class="line">                    break;</div><div class="line">                case &quot;.js&quot;:</div><div class="line">                    res.writeHead(200, &#123;&quot;Content-Type&quot;: &quot;text/javascript&quot;&#125;);</div><div class="line">                    break;</div><div class="line">                default:</div><div class="line">                    res.writeHead(200, &#123;&quot;Content-Type&quot;: &quot;application/octet-stream&quot;&#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            fs.readFile(pathname,function (err,data)&#123;</div><div class="line">                res.end(data);</div><div class="line">            &#125;);</div><div class="line">        &#125; else &#123;</div><div class="line">            res.writeHead(404, &#123;&quot;Content-Type&quot;: &quot;text/html&quot;&#125;);</div><div class="line">            res.end(&quot;&lt;h1&gt;404 Not Found&lt;/h1&gt;&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;).listen(8080, &quot;127.0.0.1&quot;);</div></pre></td></tr></table></figure></p>
<hr>
<p>####创建Web服务<br><strong>安装Express</strong> <code>npm install express -g</code></p>
<ul>
<li>执行Express</li>
<li>目录结构<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">├─bin</div><div class="line">├─public</div><div class="line">│  ├─images</div><div class="line">│  ├─javascripts</div><div class="line">│  └─stylesheets</div><div class="line">├─routes</div><div class="line">├─views</div><div class="line">├─app.js</div><div class="line">└─package.json</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>####Express API</p>
<blockquote>
<p>Express 是一个自身功能极简，完全是由路由和中间件构成一个的 web 开发框架：从本质上来说，一个 Express 应用就是在调用各种中间件。</p>
<p>#####中间件<br>中间件是一个函数，它可以访问请求对象, 响应对象, 和 web 应用中处于请求-响应循环流程中的中间件</p>
<ul>
<li>执行任何代码。</li>
<li>修改请求和响应对象。</li>
<li>终结请求-响应循环。</li>
<li>调用堆栈中的下一个中间件。<br>#####路由<br>路由是指如何定义应用的端点（URIs）以及如何响应客户端的请求。</li>
<li>HTTP请求方法</li>
<li>请求路径</li>
<li>回调函数</li>
<li>相应函数<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line">app.get(&apos;/&apos;, function(req, res) &#123;</div><div class="line">  res.send(&apos;hello world&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<ul>
<li>Router()创建路由模块化</li>
</ul>
<hr>
<p>####引用文件<br><a href="https://nodejs.org/dist/latest-v6.x/docs/api/" target="_blank" rel="external">NodeJS官方文档</a><br><a href="http://www.expressjs.com.cn/4x/api.html" target="_blank" rel="external">Express4.x中文文档</a><br><a href="">Node.JS项目实践构建可扩展的Web应用书籍</a><br><a href="">了不起的NodeJS书籍</a><br><a href="http://www.cnblogs.com/gaoxianlyx/p/6385557.html" target="_blank" rel="external">对NodeJS事件轮询的理解</a><br><a href="http://baike.sogou.com/v8448313.htm?fromTitle=%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8" target="_blank" rel="external">事件驱动</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/0724/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/0724/" itemprop="url">使用connect-mongo为NodeJS项目添加会话session</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-25T22:22:06+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####环境说明：<br>NodeJS 6.<em>  API<a href="https://nodejs.org/dist/latest-v6.x/docs/api/" target="_blank" rel="external">https://nodejs.org/dist/latest-v6.x/docs/api/</a><br>Express 4.</em> API  <a href="http://www.expressjs.com.cn/4x/api.html" target="_blank" rel="external">http://www.expressjs.com.cn/4x/api.html</a></p>
<p>####需求说明：</p>
<ol>
<li>接收客户端传过来的js或css参数，在配置文件中找到对应的文件</li>
<li>拉取文件内容，对其拼接后，写入文件，将写入后的文件地址传回<br>####拆分需求：<br>根据需求，可以将程序拆分为如下几个步骤：</li>
</ol>
<ul>
<li>接收客户端参数</li>
<li>拉取线上文件拼接</li>
<li>拼接后写入文件</li>
<li>将其地址返回</li>
</ul>
<p>#####接收客户端参数<br>客户端发送过来的请求参数为：<a href="http://xxxx/combine?js=xx.js,xx.js,xx.js" target="_blank" rel="external">http://xxxx/combine?js=xx.js,xx.js,xx.js</a><br>则服务器端接收客户端发送过来的请求，找到对应的对于<code>/combine</code>的处理，那么服务器端是如何找到对于对应的请求的处理呢。<br>服务器端接收客户端参数是根据Express的中间件来处理，Express的中间件（Middleware） 是一个函数，它可以访问请求对象（request object (req)）, 响应对象（response object (res)）, 和 web 应用中处于请求-响应循环流程中的中间件，一般被命名为 next 的变量。express的中间件详述见<a href="http://www.expressjs.com.cn/guide/using-middleware.html" target="_blank" rel="external">express中间件</a>，打包模块主要采用了<strong>路由级中间件</strong><br>Node中的入口文件为<code>app.js</code>，其中包括引用的模块，初始化Express，以及响应所有请求的路由，app.js主要内容如下（删去了一些内容）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);//引用express模块</div><div class="line">var path = require(&apos;path&apos;);//引用node path模块</div><div class="line">var cookieParser = require(&apos;cookie-parser&apos;);</div><div class="line">var bodyParser = require(&apos;body-parser&apos;);</div><div class="line">var package = require(&apos;./package.json&apos;);//引用配置文件package.json</div><div class="line">var routes = require(&apos;./routes&apos;);//引用路由文件模块</div><div class="line">var app = express();//实例化express</div><div class="line">app.use(bodyParser.json());</div><div class="line">app.use(bodyParser.urlencoded(&#123; extended: false &#125;));</div><div class="line">app.use(cookieParser());</div><div class="line">app.use(express.static(path.join(__dirname, &apos;public&apos;)));</div><div class="line"></div><div class="line">app.use(&apos;/&apos;, routes);</div></pre></td></tr></table></figure></p>
<p>通过上面的<code>app.use(&#39;/&#39;,routes)</code>我们进入路由级中间件，改行代码表示所有过来的请求，都会进入路由级中间件执行，下面我们展示路由级中间件的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var router = express.Router();//绑定路由对象</div><div class="line">var combine = require(&apos;./combine&apos;)//combine处理函数内容</div><div class="line">router.get(&apos;/combine&apos;, combine);</div><div class="line">module.exports = router;</div></pre></td></tr></table></figure></p>
<p>这样我们就可以找到combine函数，然后在combine函数中处理参数，进行一系列操作。<br>如下为<code>combine</code>函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">function combine(req,res,next)&#123;&#125;</div></pre></td></tr></table></figure></p>
<p>在函数中<code>req</code>即为请求参数，里面<code>req.query.js</code>即可得到js的参数</p>
<p>#####拉取线上文件拼接<br>通过传递过来的参数我可以解析出对应的js函数名称，但是这个js名称只是简写，我们需要通过一个特定的配置文件，找出其线上对应的js地址，找到地址之后，将这些js加入数组，然后读取文件内容，这里采用了request模块，读取http请求，request使用方式如地址链接<a href="https://www.npmjs.com/package/request" target="_blank" rel="external">https://www.npmjs.com/package/request</a>;在combine中拉取代码主要如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">request(file).pipe(through2(function(chunk, enc, cb) &#123;</div><div class="line">    if (!this.code) &#123;</div><div class="line">        this.code = &apos;&apos;;</div><div class="line">    &#125;</div><div class="line">    this.code += chunk;</div><div class="line">        cb();</div><div class="line">    &#125;,function(cb)&#123;</div><div class="line">        </div><div class="line">    &#125;)</div><div class="line">);</div></pre></td></tr></table></figure></p>
<p>代码中的pipe为管道的概念，即在读文件时通过管道一点一点传送，在传送过程中希望对读取的字符进行处理，则一般依赖through2插件。through2插件github地址为<a href="https://www.npmjs.com/package/through2" target="_blank" rel="external">https://www.npmjs.com/package/through2</a>;在读取完一个文件之后再读取下一个，文件拼接之后的结果则是我们最终需要的内容。</p>
<p>#####拼接后写入文件<br>因为最终要返回给php端一个地址，所以需要把js拼接结果写入文件，写入文件主要采用方法为Node的fs模块中的方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fs.writeFile(filename, path, callback(error));</div></pre></td></tr></table></figure></p>
<p>在写入文件时需要指定文件路径，需要注意的是，在windows环境下调试的时候，直接就可以写入文件夹，但是在linux下则提示没有写入文件权限，于是在root操作下将文件夹权限更改为root，这样可以写入文件了，但是又出现了新的问题，新的文件时root用户，所在组为root组，服务器上启动的服务为apache，apache访问的文件权限需要是www用户组，这时就需要在代码中设定，通过调用node方法，更改生产的文件权限，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">fs.chown(path,uid,gid,function(err)&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>#####将其地址返回<br>前面提到接收客户端用的是Express提供的request参数，Express同样提供了response响应函数，返回给客户端可以用以下函数，以下两个是打包模块中用的响应函数，其它详细请见Express API：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">res.send([body])</div><div class="line">//Sends the HTTP response.The body parameter can be a Buffer object, a String, an object, or an Array. For example:</div><div class="line">res.end();//结束响应不需要任何参数</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/0718/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/0718/" itemprop="url">关于ES2015转换es5遇到的‘this’变成‘undefined’问题查找记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-25T22:22:06+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####问题说明：<br>在使用压缩工具压缩并内置<code>babel</code>将<code>ES2015</code>转换成<code>ES5</code>打包js时，代码出现问题，代码简化后问题如下图1-1所示：</p>
<p><em>图1-1</em><br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160824/this1.png" alt=""><br><code>this</code>被识别成了<code>undefined</code>。<br>以下为问题查找记录。</p>
<p>####问题结果预说明：<br>之所以加个预说明是因为通篇记录对于该bug的查找过程，结果并没有达到完全解决，结果是以去掉某些模块为前提，直接看结果请拉到最下方<strong>结果说明</strong>。</p>
<p>####问题查找过程：</p>
<ul>
<li><p><strong>问题原因</strong></p>
<p>通过搜索，在github issue查找到对于该问题的讨论<a href="https://github.com/babel/babelify/issues/37" target="_blank" rel="external">github issue:this is undefined for React components #37</a>;issue中对于该问题讨论如下图1-2：</p>
</li>
</ul>
<p><em>图1-2</em><br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160824/this2.png" alt=""><br>图上说导致原因为<code>babel-plugin-transform-es2015-modules-commonjs</code>,在进入该js的src目录下得<code>index.js</code>文件中，通过查找有一块代码如下图1-3：</p>
<p><em>图1-3</em><br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160824/this3.png" alt=""><br>也就是说当<code>allowTopLevelThis!=true</code>时，会把<code>this</code>变成<code>undefined</code>，那么解决方式应该为把<code>allowTopLevelThis</code>设置属性值为<code>true</code>。</p>
<ul>
<li><p><strong>属性配置</strong></p>
<p>通过<a href="https://github.com/babel/babel/tree/master/packages/babel-plugin-transform-es2015-modules-commonjs" target="_blank" rel="external"> babel-plugin-transform-es2015-modules-commonjs</a>的<code>readme</code>文件可以找到更改配置的方式有三种如图1-4：</p>
</li>
</ul>
<p><em>图1-4</em><br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160824/this4.png" alt="">主要看第一种和第三种，第一种即在根目录添加<code>.babelrc</code>配置文件，第三种为在引入<code>babel-core</code>模块或者进行转换时进行配置.</p>
<ul>
<li><strong>配置测试</strong></li>
</ul>
<p>环境说明：使用<code>ezpack</code>压缩如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(function()&#123;</div><div class="line">&#125;).call(this)</div></pre></td></tr></table></figure></p>
<p>在<code>babel-plugin-transform-es2015-modules-commonjs&gt;lib&gt;index.js</code>中增加了三个console.log代码：如下图1-5所示：</p>
<p><em>图1-5</em><br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160824/this6.png" alt=""><br><code>.babelrc</code>中配置代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  presets: [</div><div class="line">    [&quot;es2015&quot;]</div><div class="line">  ],</div><div class="line">  &quot;plugins&quot;: [</div><div class="line">    [&quot;transform-es2015-modules-commonjs&quot;, &#123;</div><div class="line">      &quot;allowTopLevelThis&quot;: true</div><div class="line"></div><div class="line">    &#125;]</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是控制台中打印出来的结果确不是我们想要的结果，打印结果如下1-6：</p>
<p><em>图1-6</em><br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160824/this7.png" alt=""><br>控制台中仍然打印出了undefined，而不是只有true，也就是说我们配置的属性<code>allowTopLevelThis</code>并没有完全的起作用，更令人费解的是既打出了<code>true</code>又打出了<code>undefined</code>面对这种情况开始了更苦逼的查bug之路。</p>
<ul>
<li><strong>继续查找bug</strong></li>
</ul>
<p>继续查找bug过程中主要分为两个部分：</p>
<p> <strong>1. 找到了代替的<a href="https://github.com/Collaborne/babel-preset-es2015-script" target="_blank" rel="external">babel-preset-es2015-script</a></strong></p>
<p>打开<code>github</code>连接直接就是<code>readme</code>文件，在<code>.babelrc</code>中配置如下,<code>presets</code>中不再配置<code>es2015</code>,而是配置<code>es2015-script</code>,代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;presets&quot;: [&quot;es2015-script&quot;]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试发现转换后的文件是<code>call(this)</code>,而非<code>call(undefined)</code>,转换成功，至于调试的<code>babel-plugin-transform-es2015-modules-commonjs</code>中的<code>console.log</code>,根本就没有出现，通过查看<code>babel-preset-es2015-script</code>的<code>index.js</code>文件，发现里面并没有引用<code>babel-plugin-transform-es2015-modules-commonjs</code>模块，这个提供了一个思路就是如果在<code>babel-es2015-script</code>中也不引用该模块，那么是否就可以解决问题了呢？然后我们回到<code>babel-es2015-script</code>中的<code>index.js</code>文件，如下图1-7所示：</p>
<p><em>图1-7</em><br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160824/this8.png" alt="babel-es2015-script index.js">,我们注释红框内的代码，也就是把引用<code>commonjs</code>模块的部分全都注释掉，然后采用配置测试中的<code>babelrc</code>文件执行，控制台打印如下图1-8：</p>
<p><em>图1-8</em><br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160824/this9.png" alt=""><br>注释掉该模块后就不再打印<code>undefined</code>，而true存在的原因则是因为配置文件中的属性更改起了作用，模块注释并不代表这个文件不存在，通过跟踪堆栈发现，当检索到<code>.babelrc</code>时，依然引用了该模块，这也可以解释为什么图1-6中打印出的信息为既有<code>true</code>又有<code>undefined</code>,也不知道为什么配置文件没有pk过原来的引用模块。</p>
<p><strong>2. 查找<a href="https://github.com/babel/babel/tree/master/packages/babel-preset-es2015" target="_blank" rel="external">babel-preset-2015</a> readme文件</strong><br>readme文件如下图1-9所示：<br><em>图1-9</em><br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160824/this10.png" alt=""><br>个人理解是在配置文件中增加<code>loose</code>配置，可以使得配置属性覆盖默认属性，此时<code>.babelrc</code>代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  presets: [</div><div class="line">    [&quot;es2015&quot;, &#123;&quot;loose&quot;: true&#125;]</div><div class="line">  ],</div><div class="line">  &quot;plugins&quot;: [</div><div class="line">    [&quot;transform-es2015-modules-commonjs&quot;, &#123;</div><div class="line">      &quot;allowTopLevelThis&quot;: true</div><div class="line"></div><div class="line">    &#125;]</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>#####但是！<br>控制台中打出的信息仍然和图1-6一模一样，既有true，又有undefined,(内心崩溃泪流满面……)，然后我把配置文件改成了这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  presets: [</div><div class="line">    [&quot;es2015&quot;, &#123;&quot;loose&quot;: true,&quot;modules&quot;: false&#125;]</div><div class="line">  ],</div><div class="line">  &quot;plugins&quot;: [</div><div class="line">    [&quot;transform-es2015-modules-commonjs&quot;, &#123;</div><div class="line">      &quot;allowTopLevelThis&quot;: true</div><div class="line">    &#125;]</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果正常通过，结果如图1-8，一切转换正常。这个配置和<code>babel-preset-es2015-script</code>起的作用是一样的，不引用<code>modules</code>模块,也就是说如果在es2015转换为es5的过程中不需要转换成这四种<code>&quot;amd&quot;, &quot;umd&quot;, &quot;systemjs&quot;, &quot;commonjs&quot;</code>module type,也可以把模块去掉。</p>
<p>####结果说明：<br><code>.babelrc</code>中配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  presets: [</div><div class="line">    [&quot;es2015&quot;, &#123;&quot;loose&quot;: true,&quot;modules&quot;: false&#125;]</div><div class="line">  ],</div><div class="line">  &quot;plugins&quot;: [</div><div class="line">    [&quot;transform-es2015-modules-commonjs&quot;, &#123;</div><div class="line">      &quot;allowTopLevelThis&quot;: true</div><div class="line">    &#125;]</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>若不想放在babelrc中可以写在代码中transform转换时刻：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var babel = require(&apos;babel-core&apos;);</div><div class="line"> var js =babel.transform(this.file, &#123;</div><div class="line">          presets:[[&apos;es2015&apos;,&#123;loose:true,modules: false&#125;]],</div><div class="line">          plugins:[[&quot;transform-es2015-modules-commonjs&quot;, &#123; allowTopLevelThis:true&#125;]],</div><div class="line"> &#125;);</div></pre></td></tr></table></figure></p>
<p>即可把<code>this</code>改成<code>undefined</code>,但是通过配置去掉了<a href="http://babeljs.io/docs/plugins/transform-es2015-modules-amd/" target="_blank" rel="external">es2015-modules-amd</a>、<a href="http://babeljs.io/docs/plugins/transform-es2015-modules-commonjs/" target="_blank" rel="external">es2015-modules-commonjs</a>、<a href="http://babeljs.io/docs/plugins/transform-es2015-modules-systemjs/" target="_blank" rel="external">es2015-modules-systemjs</a><br>、<a href="http://babeljs.io/docs/plugins/transform-es2015-modules-umd" target="_blank" rel="external">es2015-modules-umd</a>四个模块。</p>
<p>####不足之处：<br>由于测试时实在构建工具<code>ezpack</code>中测试，没有单独剥离<code>babel</code>环境，所以无法判定配置中属性<code>&quot;allowTopLevelThis&quot;: true</code>无法pk过引用模块的原因是babel本身，还是ezpack引起的，需后续单独剥离<code>babel</code>环境继续测试，文中若有不足或错误之处，或者更好的解决方式，还请多多指出。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/0714/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/0714/" itemprop="url">利用模拟滚动条解决移动页面双浮层时背景层滑动问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-25T22:22:06+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####问题说明</p>
<p>   <a href="http://cming.site/cm/scroll.html" target="_blank" rel="external">双浮层demo地址：</a></p>
<p>   <strong>浮层内容高度超出浮层既定高度</strong>（PS：这是前提，如果浮层不需要滚动，就可以return本文了），所以浮层需要滚动，当浮层滚动到底时，再向下滑动，会引起背景层的滚动。为了解决这个问题采用的方法是模拟滚动条，也就是对于浮层则通过捕获<code>touchstart</code>、<code>touchmove</code>、<code>touchend</code>事件来计算手指滑动的距离，使得浮层进行移动。</p>
<p>  在通过模拟滚动条来解决问题之前，有试过给背景层加<code>overflow:hidden</code>、试过禁止背景层的<code>touchmove</code>事件，都以失败告终，最后选择了模拟滚动条。</p>
<p>####代码说明：<br>核心代码展示如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">/*调用说明：noScroll.init(&apos;j_s_float&apos;,$(&apos;.j_s_float&apos;),$(&apos;.j_ns_float&apos;));</div><div class="line"> *@param&#123;</div><div class="line"> *  j_s_float:浮层的class的名字</div><div class="line"> *  $(&apos;.j_s_float&apos;):浮层</div><div class="line"> *  $(&apos;.j_ns_float&apos;):背景层 &#125;</div><div class="line"> */</div><div class="line">var noScroll = &#123;</div><div class="line">        y: 0 ,//手指走过的距离</div><div class="line">        disY:0,//记录每次touchmove时的初始距离</div><div class="line">        scrollTop:0,</div><div class="line">        startBool:false,</div><div class="line">        init:function(s_float,scroll_float,noscroll_float)&#123;</div><div class="line">            var self = this; </div><div class="line">            self.touchstart(s_float,scroll_float);            </div><div class="line">            noscroll_float.on(&quot;touchmove&quot;,function(e)&#123;//禁止背景层的滚动</div><div class="line">                e.preventDefault();</div><div class="line">                e.stopPropagation();          </div><div class="line">            &#125;);</div><div class="line">        &#125;,</div><div class="line">        touchstart:function(s_float,scroll_float)&#123;</div><div class="line">            var self = this;                                </div><div class="line">            if(!self.startBool)&#123;</div><div class="line">             //保证在一次touchstart未结束时，不能开启第二次start，也就是解决两个手指以上会乱跳的问题</div><div class="line">                scroll_float.bind(&quot;touchstart&quot;,function(e)&#123;</div><div class="line">                    self.y = 0;//手指划过的距离清空</div><div class="line">                    self.startBool = true;</div><div class="line">                    self.scrollTop = scroll_float[0].scrollTop</div><div class="line">                    self.disY =e.changedTouches[0].pageY;                    </div><div class="line">                    self.touchmove(s_float,scroll_float);</div><div class="line">                    self.touchend(s_float,scroll_float);</div><div class="line">                       </div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        touchmove:function(s_float,scroll_float)&#123;</div><div class="line">            var  self = this;</div><div class="line">            scroll_float.bind(&quot;touchmove&quot;,function(e)&#123;</div><div class="line">                e.preventDefault();</div><div class="line">                e.stopPropagation(); </div><div class="line">                self.y += e.changedTouches[0].pageY - self.disY;    </div><div class="line">                if(scroll_float.height()+scroll_float.get(0).scrollTop&gt;=scroll_float.get(0).scrollHeight&amp;&amp;self.y&lt;0) &#123;</div><div class="line">                    //滑到底部</div><div class="line">                    self.y = 0;</div><div class="line">                    return;</div><div class="line">                    </div><div class="line">                &#125;else if(scroll_float.get(0).scrollTop === 0&amp;&amp;self.y&gt;0)&#123;</div><div class="line">                    //滑到顶部</div><div class="line">                    self.y = 0;</div><div class="line">                    return ;</div><div class="line">                &#125;else&#123;</div><div class="line">                    self.v0 = (e.changedTouches[0].pageY - self.disY)/5;</div><div class="line"></div><div class="line">                    scroll_float[0].scrollTop=self.scrollTop-self.y ;   </div><div class="line">                    </div><div class="line">                    self.disY = e.changedTouches[0].pageY; </div><div class="line">                &#125;                                </div><div class="line">            &#125;);</div><div class="line">        &#125;,</div><div class="line">        touchend:function(s_float,scroll_float)&#123;</div><div class="line"> </div><div class="line">            scroll_float.bind(&apos;touchend&apos;, function(e) &#123;</div><div class="line">                scroll_float.unbind(&apos;touchmove&apos;);</div><div class="line">                scroll_float.unbind(&apos;touchend&apos;);</div><div class="line">            &#125;); </div><div class="line"></div><div class="line">        &#125;        </div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/0715/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/0715/" itemprop="url">移动端顶部下拉刷新实例说明</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-25T22:22:06+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://cming.site/cm/refresh.html" target="_blank" rel="external">顶部下拉刷新Demo实例</a></p>
<p>####需求说明<br>  需求如Demo演示，判断当用户有下拉的行为时，进行ajax请求发送，代码大致思路为捕获<code>touchstart</code>、 <code>touchmove</code>、<code>touchend</code>事件，根据手指滑动距离及方向判断用户的行为。</p>
<hr>
<p>####遇到的问题说明</p>
<blockquote>
<ul>
<li>事件绑定在哪里</li>
</ul>
</blockquote>
<p>Demo中是下方div滑动，应该把事件绑在下方div上，但是这样处理在QQ浏览器中有问题，QQ浏览器需要阻止<code>document</code>的<code>touchmove</code>事件，否则无法进行下拉，而阻止后再移除事件时，会在UC浏览器中产生bug，所以我在Demo中把事件绑定在了<code>document</code>的上面，因此而造成的问题是滑动上部红色部分，仍然可以下拉刷新，相比UC的大bug而言，这样体验更好。</p>
<hr>
<p>####代码说明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * 调用    drawDown.init();</div><div class="line"> */</div><div class="line">var drawDown = &#123;</div><div class="line">        pDiv : &apos;&lt;div class=&quot;dragdown_wapper&quot;&gt;&lt;div class=&quot;dragdown_loading&quot;&gt;&lt;p class=&quot;hide&quot;&gt;&lt;span&gt;&lt;img src=&quot;http://n.sinaimg.cn/mobileh5/dc9d8119/20160107/loading.gif&quot; alt=&quot;&quot;&gt;&lt;/span&gt;&lt;span&gt;加载中&lt;/span&gt;&lt;/p&gt;&lt;p data-txt=&quot;下拉可以更新&quot; data-txt1=&quot;松开可以刷新&quot; &gt;&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;&apos;,</div><div class="line">        pImg:&apos;&apos;,//加载中图片</div><div class="line">        pContent:&apos;&apos;,//文字内容</div><div class="line">        isLoad:false,</div><div class="line">        disYStart:0,//保存每次touchmmove触发的初始坐标</div><div class="line">        disYMove:0,//每次touchmove初始距离</div><div class="line">        disY:0,//每次移动总距离</div><div class="line">        wapperMarginTop:0,//下拉刷新div高度</div><div class="line">        liveTop:$(&apos;.j_liveing&apos;).offset().top,</div><div class="line">        offsetTop:0,</div><div class="line">        init:function()&#123;</div><div class="line"></div><div class="line">            var self = this;</div><div class="line">            $(&apos;.j_liveing&apos;).before(self.pDiv);</div><div class="line">            self.wapperMarginTop = $(&apos;.dragdown_wapper&apos;).height();</div><div class="line">            self.pContent = $(&apos;.dragdown_loading &apos;).find(&apos;p&apos;).eq(1);</div><div class="line">            self.pImg = $(&apos;.dragdown_loading &apos;).find(&apos;p&apos;).eq(0);</div><div class="line">            self.offsetTop = $(&apos;.dragdown_wapper&apos;).offset().top;</div><div class="line">            self.bindEvent();                 </div><div class="line">        &#125;,</div><div class="line">        bindEvent:function()&#123;</div><div class="line">            var self = this;</div><div class="line">            document.addEventListener(&quot;touchstart&quot;,function(e)&#123;</div><div class="line">                self.touchstart(e)</div><div class="line">            &#125;,false);</div><div class="line">            document.addEventListener(&quot;touchmove&quot;,function(e)&#123;</div><div class="line">                self.touchmove(e)</div><div class="line">            &#125;,false);</div><div class="line">            document.addEventListener(&quot;touchend&quot;,function(e)&#123;</div><div class="line">                self.touchend(e)</div><div class="line">            &#125;,false);</div><div class="line">        &#125;,</div><div class="line">        touchstart:function(e)&#123;</div><div class="line">            var self = this;</div><div class="line">            if(self.isLoad == &apos;true&apos;)return;</div><div class="line">            self.disYStart = e.changedTouches[0].pageY;</div><div class="line">            $(&apos;.dragdown_wapper&apos;).css(&apos;margin-top&apos;,-self.wapperMarginTop);</div><div class="line">            self.disY =  0;     </div><div class="line">            self.pContent.html(self.pContent.data(&apos;txt&apos;));//下拉即可刷新</div><div class="line">        &#125;,</div><div class="line">        touchmove:function(e)&#123;</div><div class="line">            var self = this;</div><div class="line">            if(self.isLoad == &apos;true&apos;)return;</div><div class="line">            self.disYMove = e.changedTouches[0].pageY;      </div><div class="line">            self.disY += self.disYMove - self.disYStart;//手指滑动的距离</div><div class="line">            if(self.disY &gt; 0&amp;&amp;document.body.scrollTop == 0)&#123;</div><div class="line">                e.preventDefault();</div><div class="line">                $(&apos;.dragdown_wapper&apos;).css(&apos;margin-top&apos;,-(self.wapperMarginTop-self.disY*0.4)+&apos;px&apos;);</div><div class="line">                //通过更改margin-top来移动</div><div class="line">            &#125;</div><div class="line">            self.disYStart = e.changedTouches[0].pageY;</div><div class="line">            self.pContent.html(self.pContent.data(&apos;txt1&apos;));//松开即可刷新</div><div class="line">        &#125;,</div><div class="line">        touchend:function(e)&#123;</div><div class="line">            var self = this;</div><div class="line">            if(self.isLoad == &apos;true&apos;)return;</div><div class="line">            self.isLoad = true;           </div><div class="line">            self.pImg.removeClass(&apos;hide&apos;);//加载中</div><div class="line">            self.pContent.html(&apos;&apos;);</div><div class="line">            self.pContent.addClass(&apos;hide&apos;);</div><div class="line">            if($(&apos;.dragdown_wapper&apos;).offset().top&gt;=(self.offsetTop+40))&#123;</div><div class="line">                // 模拟ajax处理</div><div class="line">               setTimeout(function()&#123;</div><div class="line">                    self.hideWrapper();</div><div class="line">                    $(&apos;body&apos;).append(&apos;&lt;div class=&quot;liver_nosay&quot; style=&quot;top:&apos;+(self.liveTop-6)+&apos;px&quot;&gt;新消息还没有出来呢&lt;/div&gt;&apos;);</div><div class="line">                    setTimeout(function()&#123;</div><div class="line">                        $(&apos;.liver_nosay&apos;).remove();</div><div class="line">                    &#125;,2000);</div><div class="line">                    self.isLoad = false;</div><div class="line">                &#125;,4000) </div><div class="line">            &#125;else&#123;</div><div class="line">                //下拉距离过短直接隐藏</div><div class="line">                self.hideWrapper();</div><div class="line">            &#125;                                </div><div class="line">        &#125;,</div><div class="line">        hideWrapper:function()&#123;</div><div class="line">            var self = this;</div><div class="line">            $(&apos;.dragdown_wapper&apos;).css(&apos;margin-top&apos;,-self.wapperMarginTop);</div><div class="line">            self.pContent.removeClass(&apos;hide&apos;);</div><div class="line">            self.pContent.html(self.pContent.data(&apos;txt&apos;));</div><div class="line">            self.pImg.addClass(&apos;hide&apos;);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/0716/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/0716/" itemprop="url">移动端页面弹幕小Demo实例说明</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-25T22:22:06+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://cming.site/cm/barrage.html" target="_blank" rel="external">弹幕小Demo实例地址</a></p>
<p><em>写在前面:尝试做了一下弹幕的实例，欢迎提出并指正问题</em></p>
<p>####问题说明：<br>Demo中页面展示如下图所示：<br><img src="http://n.sinaimg.cn/mobileh5/dc9d8119/20160715/1.jpg" alt="Demo图片"><br>如果图片挂了，请看文字说明：</p>
<p>简单的说弹幕只完成了一个功能，从右向左缓慢移动</p>
<p>Demo中所涉及到的文字参数说明如下：</p>
<ul>
<li>行走translateX=  屏幕宽度+弹幕宽度 + 70</li>
<li>行走时间：屏幕宽度/50（初始时间）+弹幕宽度/500</li>
<li>批次间隔时间：Math.min(初始时间/2，4200)</li>
<li>移除条件：left&lt;-(70+20)</li>
</ul>
<p><em>ps:以上数字为自定的，无组织无规律,也可在对话框中设定更加无组织无纪律的数字，设定时请不要带单位，并没有做正则匹配~也没有做兼容~</em></p>
<p>####未解决问题:</p>
<ul>
<li>弹幕重叠问题：当弹幕不定长时，弹幕是按照一定时间通过<code>setInterval</code>来批次放出，而不是当前一个结束划入屏幕之后，后一个再出现，如果可以判定当前什么时候在屏幕内滑到什么位置，就可以准确放出后一个弹幕，这样避免了弹幕重叠，如果给弹幕设定长则可一定程度上避免重叠。</li>
<li>批次时间间隔设定问题：时间间隔设定较长，则避免长弹幕重叠，但短弹幕空白太大，时间间隔设定过短则长弹幕重叠，问题和上一个类似，如何在弹幕不定长时批次相隔紧凑且不重叠，这两个遇到的问题目前都没有解决<br>####代码说明:<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> *弹幕调用：Barrage.danMuInit(aqueue);</div><div class="line"> *弹幕插入：Barrage.danMuInsert(aqueue,data);</div><div class="line"> *aqueue=[&#123;&apos;img&apos;:xx,&apos;content&apos;:xx&#125;]   data=&#123;&apos;img&apos;:xx,&apos;content&apos;:xx&#125;</div><div class="line"> */</div><div class="line">var config = &#123;</div><div class="line">    	init_time:&apos;&apos;,//屏幕内滑动时间</div><div class="line">    	interval_time:&apos;&apos;,//批次间隔时间</div><div class="line">    	line:&apos;&apos;,//弹幕分行</div><div class="line">    	liWidth:&apos;&apos;,//弹幕限宽</div><div class="line">    &#125;</div><div class="line">var Barrage = &#123;</div><div class="line">	    left:document.documentElement.clientWidth,</div><div class="line">	    translateX:document.documentElement.clientWidth||0,</div><div class="line">	    fontSize:&apos;12&apos;,</div><div class="line">	    color:&apos;#000&apos;,</div><div class="line">	    line:&apos;&apos;,//弹幕所分行数</div><div class="line">	    top:[],//弹幕分行时绝对定位top值</div><div class="line">	    init_time:&apos;&apos;,//弹幕屏内滑动时间</div><div class="line">	    interval_time:&apos;&apos;,//弹幕每批出现间距时间</div><div class="line">	    timeCacluate:&apos;&apos;,//弹幕暂停</div><div class="line">	    liWidth:&apos;&apos;,//强制设置liwidth</div><div class="line">	    danMuInit:function(data)&#123;</div><div class="line">	    	var self = this;</div><div class="line">	    	self.top = [];</div><div class="line">	    	self.line = parseInt(config.line)||3;</div><div class="line">	    	self.init_time = parseInt(config.init_time)||document.documentElement.clientWidth/50;</div><div class="line">	    	self.interval_time = parseInt(config.interval_time)||Math.min(self.init_time*1000/2,4200);</div><div class="line">	    	for(var i = 0 ;i &lt; self.line;i++)&#123;</div><div class="line">	    		self.top.push(&apos;&apos;+i*30+&apos;px&apos;);</div><div class="line">	    	&#125;;</div><div class="line">	    	self.liWidth = parseInt(config.liWidth);</div><div class="line">	    	</div><div class="line">	    	self.danMuPlay(aqueue);</div><div class="line">	    &#125;,</div><div class="line">	    danMuPlay:function(data)&#123;</div><div class="line">	        if(typeof(data)==&apos;underined&apos;)&#123;return;&#125;</div><div class="line">	        var self = this;</div><div class="line">	        var strLength = 0;</div><div class="line">	        var strWidth = 0;</div><div class="line">	        var add_time = 0;//与init_time共同构成行走时间</div><div class="line">	        </div><div class="line">	        self.timeCacluate = setInterval(function()&#123;</div><div class="line">	            var arr = [];</div><div class="line">	            for(var x = 0;x&lt;self.top.length&amp;&amp;data.length &gt; 0;x++)&#123;                    </div><div class="line">	                arr.push(&apos;&lt;li data-type=&quot;&apos;+data[0].type+&apos;&quot; data-mid=&quot;&apos;+data[0].source_id+&apos;&quot; style=&quot;position: absolute;left:&apos;+self.left+&apos;px;top:&apos;+self.top[x]+&apos;;display: inline-block;white-space: pre;&quot;&gt;&apos;);</div><div class="line">	                arr.push(&apos;&lt;img src=&quot;&apos;+data[0].img+&apos;&quot; alt=&quot;&quot; /&gt;&apos;);</div><div class="line">	                arr.push(&apos;&lt;span&gt;&apos;+data[0].content+&apos;&lt;/span&gt;&apos;);</div><div class="line">	                arr.push(&apos;&lt;/li&gt;&apos;);</div><div class="line">	                //重复播放时数据填充</div><div class="line">	                var t = data.shift();</div><div class="line">	                bqueue.push(t);</div><div class="line">	                </div><div class="line">	            &#125;;</div><div class="line">	            $(&apos;.j_barrage&apos;).find(&apos;ul&apos;).append(arr.join(&apos;&apos;));  </div><div class="line">	            $(&apos;.j_barrage&apos;).find(&apos;ul span&apos;).css(&apos;width&apos;,&apos;&apos;+self.liWidth+&apos;px&apos;);   </div><div class="line">	            var liWidth = 0;//此li用于非定宽时存储每个li宽度</div><div class="line">	            var liLength = $(&apos;.j_barrage&apos;).find(&apos;ul&apos;).children().length;</div><div class="line"></div><div class="line">	            for(var j = 0;j &lt; liLength;)&#123;                              </div><div class="line">	                for(k = 0;k&lt;self.top.length&amp;&amp;j &lt; liLength;k++)&#123;         </div><div class="line">	                    liWidth = $(&apos;.j_barrage&apos;).find(&apos;li&apos;).eq(j).width();</div><div class="line">	                    add_time = liWidth/500;</div><div class="line">	                    $(&apos;.j_barrage&apos;).find(&apos;li&apos;).eq(j).css(&#123;</div><div class="line">	                        &apos;transform&apos;:&apos;translateX(-&apos;+(self.left+liWidth+70)+&apos;px)&apos;,</div><div class="line">	                        &apos;left&apos;:&apos;&apos;+self.left+&apos;px&apos; ,</div><div class="line">	                        &apos;transition&apos;:&apos;transform &apos;+(self.init_time+add_time)+&apos;s linear&apos;</div><div class="line">	                    &#125;);</div><div class="line">	                    j++;</div><div class="line"></div><div class="line">	                &#125;</div><div class="line">	            &#125;      </div><div class="line">	            if(data.length == 0)&#123;</div><div class="line">	                self.danMuPause();</div><div class="line">	            &#125; </div><div class="line">	        &#125;,self.interval_time)                 </div><div class="line">	        </div><div class="line">	        </div><div class="line">	        self.danMuClear();</div><div class="line">	        </div><div class="line">	    &#125;,</div><div class="line">	    danMuInsert:function(queue,data)&#123;</div><div class="line">	        var self = this;</div><div class="line">	        var img =  &apos;http://tva1.sinaimg.cn/default/images/default_avatar_male_50.gif&apos;;</div><div class="line">	        setTimeout(function()&#123;</div><div class="line">	           queue.unshift(&#123;&apos;img&apos;:img,&apos;content&apos;:data.content&#125;); </div><div class="line">	           if(queue.data == &apos;&apos;)&#123;</div><div class="line"></div><div class="line">	           		self.danMuPlay(queue);</div><div class="line">	           &#125;</div><div class="line">	           </div><div class="line">	       &#125;,2000);</div><div class="line">	    &#125;,</div><div class="line">	    danMuClear:function()&#123;</div><div class="line">	        var clearLi = setInterval(function()&#123;</div><div class="line">	            for(var i = 0;i&lt;$(&apos;.j_barrage&apos;).find(&apos;ul&apos;).children().length;i++)&#123;</div><div class="line">	                if($(&apos;.j_barrage&apos;).find(&apos;ul&apos;).children().eq(i).offset().left&lt;-90)&#123;</div><div class="line">	                	console.log(&apos;remove&apos;)</div><div class="line">	                    $(&apos;.j_barrage&apos;).find(&apos;ul&apos;).children().eq(i).remove();</div><div class="line">	                &#125;</div><div class="line">	            &#125;</div><div class="line">	        &#125;,1000)</div><div class="line">	    &#125;,</div><div class="line">	    danMuPause:function()&#123;</div><div class="line">	    	var self = this;</div><div class="line">	    	clearInterval(self.timeCacluate);</div><div class="line">	    &#125;</div><div class="line">	&#125;;</div></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/0717/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/0717/" itemprop="url">5种样式实现div容器中三图摆放实例对比说明</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-25T22:22:06+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://cming.site/cm/threepics.html" target="_blank" rel="external">demo地址</a></p>
<p>####需求说明：<br>如下图所示为设计图，希望在图片上传无规则无规律的情况下实现设计。<br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160721/QQTuPian20160721105556.jpg" alt=""></p>
<p>####结论说明：<br><strong>并没有完美解决上传图片尺寸无规则但显示完美展现设计图的方案</strong>，（ps：如果小伙伴们有更好的方法，请联系我~）。题中说采用了5种样式，其中前4种为css样式处理，第5种为通过js处理。</p>
<p><strong>一图说明5种样式区别</strong><br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160721/three.jpg" alt=""></p>
<p>####样式代码说明：</p>
<blockquote>
<p>第一种样式图集1</p>
</blockquote>
<p>第一种样式是采用了<code>background</code>的方式，把图片作为背景的url,使用<code>background-size:cover</code>使图片覆盖，位置选用了居中，图片撑开选用了占位图；css左右采用<code>flex</code>分割。（请忽略和设计图不一样非2:1分割的问题，因为没有找到2:1的占位图……）;示例为上方的图集1，可以看出图片是居中覆盖，且随着屏幕的增大而不改变图片，但是由于图片居中所以会显示不全吗，且针对竖图时截的莫名其妙。</p>
<p>主要的html结构(左边容器):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;left_hd&quot;&gt;</div><div class="line">    &lt;div class=&quot;img_wrap &quot; &gt;</div><div class="line">       &lt;div  class=&quot;real_img&quot; style=&quot;background-image: url(http://www.sinaimg.cn/dy/slidenews/2_img/2016_27/76980_1845028_808632.jpg);&quot;&gt;&lt;/div&gt;</div><div class="line">        &lt;img  data-index=&quot;0&quot; src=&quot;http://n.sinaimg.cn/mobileh5/dc9d8119/20160719/atlas_load01.jpg&quot; alt=&quot;&quot;&gt;</div><div class="line">   &lt;/div&gt;</div><div class="line"> &lt;/div&gt;</div></pre></td></tr></table></figure></p>
<p>涉及的css：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">.wrap_hd&#123;</div><div class="line">    clear: both;</div><div class="line">    overflow: hidden;</div><div class="line">    display: box;</div><div class="line">    display: -webkit-box;</div><div class="line">    display: flex;</div><div class="line">    margin-top: 5px;</div><div class="line">&#125;</div><div class="line">.left_hd&#123;</div><div class="line">    box-flex:1;</div><div class="line">    -webkit-box-flex:1;</div><div class="line">    flex:1;</div><div class="line">    margin-right: 5px;</div><div class="line">&#125;</div><div class="line">.left_hd .img_wrap&#123;</div><div class="line">    overflow: hidden;</div><div class="line">    position: relative;</div><div class="line">&#125;</div><div class="line">.right_hd&#123;</div><div class="line">    box-flex:1;</div><div class="line">    -webkit-box-flex:1;</div><div class="line">    flex:1;</div><div class="line">&#125;</div><div class="line">.right_hd .img_wrap&#123;</div><div class="line">    position: relative;</div><div class="line">    overflow: hidden;</div><div class="line">&#125;</div><div class="line">.wrap_hd .real_img&#123;</div><div class="line">    width: 100%;</div><div class="line">    height: 100%;</div><div class="line">    background-repeat: no-repeat;</div><div class="line">    background-position: center center;</div><div class="line">    background-size: cover;</div><div class="line">    position: absolute;</div><div class="line">    left: 0;</div><div class="line">    right: 0;</div><div class="line">    top: 0;</div><div class="line">    bottom: 0;</div><div class="line">    z-index: 2;</div><div class="line">&#125;</div><div class="line">.right_hd div&#123;   </div><div class="line">    overflow: hidden;</div><div class="line"></div><div class="line">&#125;</div><div class="line">.right_hd .img_wrap:first-child&#123;</div><div class="line">    margin-bottom: 4px;</div><div class="line">&#125;</div><div class="line">.right_hd .img_wrap:last-child&#123;</div><div class="line">&#125;</div><div class="line">.wrap_hd img&#123;</div><div class="line">    max-width: none;</div><div class="line">    width: 100%;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>第二种样式图集2</p>
</blockquote>
<p>第二种样式及以下html结构与第一种样式不同，以下样式都是通过限制元素<code>img</code>及其父元素的宽高来限制图片<br>图集样式2是通过给图片限高固定200，而宽度按图来定做的，优点是高度保持不变，且图片不会被拉伸，缺点就是图片无法铺满而导致的视觉不好看。</p>
<p>主要的html如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;wrap_hd1&quot;&gt;</div><div class="line">    &lt;div class=&quot;left_hd1&quot;&gt;</div><div class="line">        &lt;img  data-index=&quot;0&quot; src=&quot;http://www.sinaimg.cn/dy/slidenews/2_img/2016_27/76980_1845028_808632.jpg&quot; alt=&quot;&quot;&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">    &lt;div class=&quot;right_hd1&quot;&gt;</div><div class="line">        &lt;div &gt;                                      </div><div class="line">            &lt;img  data-index=&quot;1&quot; src=&quot;http://m1.sinaimg.cn/maxwidth.2880/m1.sinaimg.cn/1e072ed856226419f37c4e24b4e91b81_683_1024.jpg&quot; alt=&quot;&quot;&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div&gt;</div><div class="line">            &lt;img  data-index=&quot;2&quot; src=&quot;http://www.sinaimg.cn/dy/slidenews/4_img/2016_29/704_1970744_807346.jpg&quot; alt=&quot;&quot;&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">    &lt;/div&gt;     </div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure></p>
<p>主要的css为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.wrap_hd1 .left_hd1 img&#123;</div><div class="line">    width: auto;</div><div class="line">    height:200px;</div><div class="line">&#125;</div><div class="line">.wrap_hd1 .right_hd1 img&#123;</div><div class="line">    width: auto;</div><div class="line">    height:98px;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>第三种样式图集3</p>
</blockquote>
<p>第三种样式是高度保持固定200px，而宽度会被铺满，如图集3，一个明显的缺点就是过宽时图片会被拉伸。感觉项目中不会采用这种方式的。html同图集2.</p>
<p>主要css：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.wrap_hd1 .left_hd2 img&#123;</div><div class="line">    width: 100%;</div><div class="line">    height:200px;</div><div class="line">&#125;</div><div class="line">.wrap_hd1 .right_hd2 img&#123;</div><div class="line">    width: 100%;</div><div class="line">    height:98px;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>第四种样式图集4</p>
</blockquote>
<p>第四种样式如图集4，主要区别为高度采用<code>max-height</code>这样会使竖向无法对齐，宽度如果采用<code>width:100%</code>图片会拉伸，宽度如果采用<code>width:auto</code>图片会有空隙。</p>
<p>主要css：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.wrap_hd1 .left_hd3 img&#123;</div><div class="line">    width: 100%;</div><div class="line">    max-height:200px;</div><div class="line">&#125;</div><div class="line">.wrap_hd1 .right_hd3 img&#123;</div><div class="line">    width: 100%;</div><div class="line">    max-height:98px;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>第五种样式图集5</p>
</blockquote>
<p>第五种样式在demo中有两个，一种是左边为横图图集，一种是左边为竖图图集，区别在于横图截取右侧部分，竖图截取下侧部分。js主要过程就是图片加载完成后获取当前图片的宽高，以及其父容器的宽高，两者相对比来决定当前容器中的图以定宽还是定高。缺点是过宽会有空隙。<br>主要js：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">$(&apos;.j_hdphoto img&apos;).each(function()&#123;</div><div class="line">    var self = this,</div><div class="line">        box_width,</div><div class="line">        box_height,</div><div class="line">        box_scale,</div><div class="line">        img_width,</div><div class="line">        img_height,</div><div class="line">        img_scale;</div><div class="line">    var img = new Image();</div><div class="line">    console.log(self.src);</div><div class="line">    img.onload=function()&#123;</div><div class="line">        box_width = $(self).parent().width();</div><div class="line">        box_height = $(self).parent().height() != 0?$(self).parent().height():1;</div><div class="line">        box_scale = box_width/box_height;//父容器</div><div class="line">        img_width = $(self).width();</div><div class="line">        img_height = $(self).height() != 0?$(self).height():1;</div><div class="line">        img_scale = img_width/img_height;//图片</div><div class="line">        if(box_scale&lt;img_scale)&#123;</div><div class="line">            //图片太宽</div><div class="line">            if(img_scale&gt;1)&#123;</div><div class="line">                //横图</div><div class="line">                $(self).css(&apos;height&apos;,box_height);</div><div class="line">            &#125;else&#123;</div><div class="line">                //竖图</div><div class="line">                $(self).css(&apos;width&apos;,box_width);</div><div class="line">            &#125;</div><div class="line">        &#125;else&#123;</div><div class="line">            //图片太高</div><div class="line">            if(img_scale&gt;1)&#123;</div><div class="line">                //图片是个横图</div><div class="line">                $(self).css(&apos;height&apos;,box_height);</div><div class="line">                </div><div class="line">            &#125;else&#123;</div><div class="line">                //竖图</div><div class="line">                $(self).css(&apos;width&apos;,box_width);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">        img.onload = null;</div><div class="line">    &#125;</div><div class="line">    img.src = self.src;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>####结论：<br>几种pk一下，感觉图集1、图集5还是比较可取的，做一个这样的对比主要是想说以后产品要求这个图就可以一个demo解决啦！有错误之处还请多多指教。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/0723/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/0723/" itemprop="url">使用Resource Timing API分析前端性能探索（一）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-25T22:22:06+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####参考文档：<br><a href="https://www.w3.org/TR/2011/WD-resource-timing-20110811/" target="_blank" rel="external">https://www.w3.org/TR/2011/WD-resource-timing-20110811/</a></p>
<p><a href="https://github.com/w3c/resource-timing" target="_blank" rel="external">https://github.com/w3c/resource-timing</a></p>
<p><a href="https://segmentfault.com/a/1190000004010453" target="_blank" rel="external">使用性能API快速分析web前端性能</a></p>
<p><a href="http://ju.outofmemory.cn/entry/171909" target="_blank" rel="external">译：严重混乱的 Resource Timing</a></p>
<p><a href="http://ju.outofmemory.cn/entry/110290" target="_blank" rel="external">译：Resource Timing (资源计时) 使用技巧</a></p>
<p><a href="http://www.cnblogs.com/starof/p/5481935.html" target="_blank" rel="external">Chrome Developer Tools：Network Panel说明</a></p>
<p>####基本说明：<br><code>Resource Timing</code>可以获取到单个静态资源从开始发出请求到获取响应之间各个阶段的Timing。主要用法如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">window.performance.getEntriesByType(&quot;resource&quot;)</div></pre></td></tr></table></figure></p>
<p>在控制台中显示如下：<br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20161104/performance.png" alt=""><br>主要API所取时间如下图所示：<br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20161104/resource-timing-overview.png" alt="">;</p>
<p>######API主要分为两类：<br><strong>（一）：同域或者跨域都可以使用的属性：</strong></p>
<ul>
<li>name – URL 地址</li>
<li>entryType – 通常是 “resource”</li>
<li>startTime – 开始处理这个资源的时间（相对开始导航到页面时的毫秒数）</li>
<li>duration – 处理这个资源的总耗时（毫秒）</li>
</ul>
<p><strong>（二）：只有同域资源可以访问到的属性（跨域也可以访问，但是拿不到数据）</strong></p>
<ul>
<li>redirectStart</li>
<li>redirectEnd</li>
<li>fetchStart</li>
<li>domainLookupStart</li>
<li>domainLookupEnd</li>
<li>connectStart</li>
<li>connectEnd</li>
<li>secureConnectionStart</li>
<li>requestStart</li>
<li>responseStart</li>
<li>responseEnd</li>
</ul>
<p>通过图示及API我们可以得出：</p>
<p><strong>DNS查询时间：</strong><code>dns = domainLookupEnd - domainLookupStart</code>;</p>
<p><strong>TCP链接时间：</strong><code>tcp = connectEnd - connectStart</code>;</p>
<p><strong>waiting时间：</strong><code>wait = responseStart - requestStart</code></p>
<p><strong>响应时间：</strong> <code>content = responseEnd - responseStart</code></p>
<p><strong>总耗时:</strong> <code>duration</code></p>
<p>在google 的network中我们可以拿到addjsv3.js的时间消耗，如下图所示：<br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20161104/addjs.png" alt="">;</p>
<p>最后的27.13ms就是我们拿到的<code>duration</code>属性的值。</p>
<p><strong>该面板属性具体解释为：</strong></p>
<ul>
<li><p>Queueing:可能是在本地防火墙的等待时间，或者是某些插件拦截时间。</p>
</li>
<li><p>Stalled：网络延时。指浏览器得到要发出这个请求的指令，到请求可以发出的等待时间。一般是代理协商、以及等待可复用的TCP连接释放的时间，不包括DNS查询、建立TCP连接时间等。</p>
</li>
<li><p>Proxy Negotiation:与代理服务器的连接时间。</p>
</li>
<li><p>DNS LookUp：表示DNS查询时间，如果第一次访问的是域名就需要查找，IP地址的话不需要，上图中没有这个参数，说明本地缓存了域名服务器的IP，浏览器不需要查询，直接通过IP请求服务器。</p>
</li>
<li><p>Initail Connection：建立连接的时间，包括 TCP handshakes/retries和negotiating a SSL.</p>
</li>
<li><p>Request sent:发送HTTP请求到服务器的时间，即上传时间，这个时间取决于发送请求的数据量的大小。</p>
</li>
<li><p>Waiting(TTFB)：发送请求后收到响应的第一个字节所花费的时间，TTFB(time to first bytes)；这是服务器优化的重要指标，服务器优化的目的就是减少这个时间。</p>
</li>
<li><p>Content Download：从服务器获取响应数据的时间，下载时间，即上面的Time减去Latency的时间，这是反应带宽的重要指标。受响应消息内容大小，网络带宽，是否使用http压缩等影响。<br>以上解释来源于<a href="http://www.cnblogs.com/starof/p/5481935.html" target="_blank" rel="external">Chrome Developer Tools：Network Panel说明</a><br>####问题说明：</p>
</li>
<li><p>1、跨域问题：<br>如果资源与网页不同域，则拿到的很多属性值都为0，查看了一下新浪、腾讯、网易新闻的首页，基本都是跨域访问资源，只能拿到最终的结果<code>duration</code>，而无法拿到具体数据，目前解决的方式是给跨域资源添加 <code>Access-Control-Allow-Origin:*</code> 响应头,如聚划算的页面，该页面可以拿到各资源具体数据：<br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20161104/juhuas.png" alt=""></p>
</li>
<li><p>2、<code>duration</code>问题<br>由于同源问题的限制，网页中大部分资源都是跨域的，所以<code>duration</code>基本成为度量时间的唯一指标，但是<code>duration</code>包含了 阻塞时间（blocking time）—— 浏览器 意识到需要下载一个资源，到这个资源实际被下载直接的时间延迟。阻塞会在几种情况时发生，最典型的资源数量比 TCP 连接数要多的情况。所以 duration 时间 比实际的下载时间要长很多，在翻译的原文中强调<a href="http://www.stevesouders.com/blog/2014/11/25/serious-confusion-with-resource-timing/" target="_blank" rel="external">http://www.stevesouders.com/blog/2014/11/25/serious-confusion-with-resource-timing/</a>我们衡量性能的时间准确来说应该是<code>dns+tcp+wait+content</code>,在github上也建议添加有别于<code>duration</code>的<code>networkDuration</code>属性，但是目前还没有被更好的支持说明，如果可以把静态服务器上的所有资源添加响应头，拿到的数据就可以更精确，但是据说咱们有几百台服务器，仍然是一个特别大的工作量。</p>
</li>
<li><p>3、返回<code>0</code>的含义<br>跨域导致的受限访问的 Resource Timing 属性会被设置为 0，如果资源是从缓存中读取的，属性同样会为0，对此，该文章有更详细的介绍<a href="http://ju.outofmemory.cn/entry/110290" target="_blank" rel="external">译：Resource Timing (资源计时) 使用技巧</a></p>
</li>
<li><p>4、兼容性<br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20161104/04173219.png" alt=""><br>在手机上测试，兼容性也比较差：</p>
</li>
<li><p><strong>IOS都不支持该属性</strong></p>
</li>
<li><strong>Android UC浏览器目前不支持该属性</strong></li>
</ul>
<p>虽然支持度不太好，但是我们仍然可以收到到部分数据，也可以做个简单的汇总，尤其是在收集到的数据中看到了有的收集UA是windows phone的，期待它被更好的支持。</p>
<p>####写在后面<br>以上为通过查阅文档、博客后的初步总结，若有错误还请多多指正。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/0719/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/0719/" itemprop="url">利用socket.io+nodejs打造简单聊天室</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-25T22:22:06+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####demo获取：<br><a href="https://github.com/a67c/ezsocket" target="_blank" rel="external">demo地址</a><br>下载后再<code>package.json</code>所在位置打开命令行，通过<code>npm install</code>安装依赖，安装好后通过<code>node app.js</code> 启动服务，在google浏览器中输入 <code>localhost:3000</code></p>
<p>####界面展示：<br>首先展示demo的结果界面，只是简单消息的发送和接收，包括发送文字和发送图片。<br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160909/123.png" alt=""><br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160909/345.png" alt=""><br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160909/456.png" alt=""></p>
<p>####ws说明：<br>在介绍socket.io之前，先简单介绍一下websocket：</p>
<blockquote>
<p>Web Socket的目标是在一个单独的持久连接上提供全双工，双向通信</p>
</blockquote>
<p>在JavaScript中建立了Web Socket之后，会有一个HTTP请求发送到浏览器以发送连接。取得服务器响应之后，建立的连接会使用HTTP升级从HTTP协议交换为WebSocket协议。WebSocket使用了自定义的协议，所以URL模式略有不同，未加密的是ws://，加密的是wss://，使用WebSocket的好处在于：可以在客户端和服务器端发送少量数据，减少开销，且由于全双工通信，适合即时应用。但是目前还达不到浏览器完全兼容。</p>
<p>####Socket.IO<br><a href="http://socket.io/" target="_blank" rel="external">Socket.IO官网</a><br>官网列出了Socket.IO的四大优点：</p>
<ul>
<li>实时分析：将数据推送到客户端，这些客户端会被表示为实时计数器，图表或日志客户。</li>
<li>实时通信和聊天：只需几行代码便可写成一个Socket.IO的”Hello,World”聊天应用。</li>
<li>二进制流传输：从1.0版本开始，Socket.IO支持任何形式的二进制文件传输，例如：图片，视频，音频等。</li>
<li><p>文档合并：允许多个用户同时编辑一个文档，并且能够看到每个用户做出的修改。<br>Socket.IO对于支持ws的浏览器将采用ws通信，对于不支持ws的将采用轮询方式，所以Socket.IO是一个非常适合做即时通讯的类库。<br>####Socket.IO API<br><em>由于Socket.IO在不同版本中，API会略有不同，所以本文介绍依赖于1.4.5版本（2016.9.8）</em><br>官网对于API及用法介绍全面，在此只做简单总结：</p>
</li>
<li><p>1、安装：npm install socket.io</p>
</li>
<li><p>2、客户端：客户端需引用socket.io.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;script src=&quot;/javascripts/socket.io.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;script&gt;var socket = io.connect();&lt;/script&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>3、服务器端：demo中服务器端采用框架<code>express(~4.13.1)</code>，将引用模块命名为io</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">```</div><div class="line">//引入模块</div><div class="line">var server = app.listen(3000,function()&#123;</div><div class="line">          console.log(&apos;Express.js server listening on port&apos;+ app.get(&apos;port&apos;));&#125;);</div><div class="line">var io = require(&apos;socket.io&apos;).listen(server);</div><div class="line">//io使用</div><div class="line">io.on(&apos;connection&apos;, function (socket) &#123;&#125;）</div></pre></td></tr></table></figure>
<ul>
<li>4、服务器端API<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">io.on(&apos;connection&apos;,function(socket)&#123;&#125;);//建立连接</div><div class="line">io.sockets.emit(约定参数，data)；//向全体人员广播</div><div class="line">io.emit(约定参数, data);//向全体人员广播</div><div class="line">socket.emit(约定参数，data)//发送信息</div><div class="line">socket.on(约定参数，callback）；//接收信息</div><div class="line">socket.on(&apos;disconnect&apos;,callback);//用户断开连接触发事件</div></pre></td></tr></table></figure>
</li>
</ul>
<p>Socket.IO对于每一个连接用户会自动分配一个随机的，不重复的<code>Socket#id</code> ，通过<code>Socket#id</code>可以实现将信息分发给个人<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var socketId = socket.id;</div><div class="line">socket.broadcast.to(socketId ).emit(&apos;my message&apos;, msg);//socket均为connect中回调函数中的socket</div></pre></td></tr></table></figure></p>
<ul>
<li><p>5、客户端API</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">socket.emit(约定参数，data)//发送信息</div><div class="line">socket.on(约定参数，callback）；//接收信息</div></pre></td></tr></table></figure>
</li>
<li><p>6、Socket.IO还可以按照命名空间划分出不同的空间，详见<a href="http://socket.io/docs/rooms-and-namespaces/" target="_blank" rel="external">http://socket.io/docs/rooms-and-namespaces/</a><br>####Demo介绍<br>package.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;name&quot;: &quot;ezsocket&quot;,</div><div class="line">  &quot;version&quot;: &quot;0.0.0&quot;,</div><div class="line">  &quot;private&quot;: true,</div><div class="line">  &quot;scripts&quot;: &#123;</div><div class="line">    &quot;start&quot;: &quot;node app.js&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;dependencies&quot;: &#123;</div><div class="line">    &quot;body-parser&quot;: &quot;~1.13.2&quot;,</div><div class="line">    &quot;cookie-parser&quot;: &quot;~1.3.5&quot;,</div><div class="line">    &quot;debug&quot;: &quot;~2.2.0&quot;,</div><div class="line">    &quot;express&quot;: &quot;~4.13.1&quot;,</div><div class="line">    &quot;jade&quot;: &quot;~1.11.0&quot;,</div><div class="line">    &quot;morgan&quot;: &quot;~1.6.1&quot;,</div><div class="line">    &quot;multiparty&quot;:&quot;4.1.2&quot;,</div><div class="line">    &quot;socket.io&quot;:&quot;1.4.5&quot;,</div><div class="line">    &quot;serve-favicon&quot;: &quot;~2.3.0&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>框架及版本如上，视图采用jade模板，主要过程为用户进入聊天室先输入名字（未查重），点击确定后发送名字等信息，进入聊天页面，在文本框中输入，点击发送按钮，发送信息。接收服务器端的相应信息，对其处理，进行界面的展示。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">$(function()&#123;</div><div class="line">	var socket=io.connect();</div><div class="line">	$(&apos;.j_btn&apos;).on(&apos;click&apos;,function()&#123;//进入页面确定按钮点击事件</div><div class="line">		console.log(8888);</div><div class="line">		var msg = $(&apos;.j_nametext&apos;).val();</div><div class="line">		socket.emit(&apos;login&apos;,msg);//向服务器发送用户注册名字信息</div><div class="line">	&#125;)</div><div class="line">	$(&apos;#j_mesbtn&apos;).on(&apos;click&apos;,function()&#123;//文本框按钮点击事件</div><div class="line">		var data = $(&apos;#j_msgtext&apos;).html();</div><div class="line">		console.log(data);</div><div class="line">		var str = &apos;&lt;li&gt;&lt;div class=&quot;top-right-content&quot;&gt;&lt;pre&gt;&apos;+data+&apos;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;&apos;</div><div class="line">		$(&apos;.right-top-ul&apos;).append(str);</div><div class="line">		socket.emit(&apos;msg&apos;,data);//向服务器发送文本框中信息</div><div class="line">	&#125;)</div><div class="line">	socket.on(&apos;system&apos;,function(data)&#123;//接收服务器端信息</div><div class="line">		var str = &apos;&lt;li class=&quot;right-top-time&quot; style=&quot;color:red&quot;&gt;欢迎  &apos;+data+&apos;  进入聊天室，撒花&lt;/li&gt;&apos;;</div><div class="line">		$(&apos;.right-top-ul&apos;).append(str);</div><div class="line">	&#125;);</div><div class="line">	socket.on(&apos;chat&apos;,function(data)&#123;</div><div class="line">		console.log(data);</div><div class="line">		var str = &apos;&lt;li&gt;&lt;div class=&quot;top-left-content&quot;&gt;&lt;span&gt;&apos;+data.name+&apos;&lt;/span&gt;&lt;pre&gt;&apos;+data.data+&apos;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;&apos;</div><div class="line">		$(&apos;.right-top-ul&apos;).append(str);</div><div class="line">	&#125;)</div><div class="line">	socket.on(&apos;loginSuccess&apos;,function()&#123;//接收服务器端登录成功信息</div><div class="line">		$(&apos;.float-player&apos;).css(&apos;display&apos;,&apos;none&apos;);</div><div class="line">		$(&apos;.dialog&apos;).css(&apos;display&apos;,&apos;none&apos;);</div><div class="line">	&#125;);</div><div class="line">	socket.on(&apos;disconnect&apos;,function(data)&#123;//接收服务器端发送的用户离开的信息</div><div class="line">		console.log(data);</div><div class="line">		var str = &apos;&lt;li class=&quot;right-top-time&quot; style=&quot;color:red&quot;&gt;  &apos;+data+&apos;  离开了组织，愿他早日回到组织的怀抱&lt;/li&gt;&apos;;</div><div class="line">		$(&apos;.right-top-ul&apos;).append(str);</div><div class="line">	&#125;);</div><div class="line">	$(&apos;#j_sendmsg&apos;).on(&apos;change&apos;,function()&#123;//上传文件事件</div><div class="line">		// 判断上传文件类型</div><div class="line">		var objFile = $(&apos;#j_sendmsg&apos;).val();</div><div class="line">		var objType = objFile.substring(objFile.lastIndexOf(&quot;.&quot;)).toLowerCase();</div><div class="line">		var formData = new FormData(document.forms.namedItem(&quot;test&quot;));</div><div class="line">		$.ajax(&#123;</div><div class="line">			type : &apos;post&apos;,</div><div class="line">			url : &apos;/uploadUserImgPre&apos;,</div><div class="line">			data: formData ,</div><div class="line">			processData:false,</div><div class="line">			async:false,</div><div class="line">			cache: false,  </div><div class="line">	  		contentType: false, </div><div class="line">			success:function(re)&#123;</div><div class="line">				re.imgSrc = re.imgSrc.replace(&apos;public&apos;,&apos;&apos;);</div><div class="line">				re.imgSrc = re.imgSrc.replace(/\\/g,&apos;\/&apos;);</div><div class="line">				$(&apos;#j_msgtext&apos;).append(&apos;&lt;img src=&quot;&apos;+re.imgSrc+&apos;&quot;&gt;&apos;)</div><div class="line">			&#125;,</div><div class="line">			error:function(re)&#123;</div><div class="line">				console.log(re);</div><div class="line">			&#125;</div><div class="line">		&#125;);	</div><div class="line">	&#125;);</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>服务器端主要功能为</p>
<p>1、前方发送登录信息，服务器端接收并广播给全部用户，将登录成功信息传给客户端，客户端进行相应操作。<br>2、客户端通过发送按钮发送信息，服务器端收到后，广播给除非发送人员所有人。<br>3、用户离开，触发服务器端<code>disconnect</code>,服武器端广播给全体在线人员。<br>代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">io.on(&apos;connection&apos;, function(socket) &#123;  </div><div class="line">  console.log(socket.id);</div><div class="line">  var socketId = socket.id;</div><div class="line">  socket.on(&apos;login&apos;,function(nickname)&#123;//接收登录</div><div class="line">    socket.nickname = nickname; </div><div class="line">    socket.emit(&apos;loginSuccess&apos;);//发送登录成功信息</div><div class="line">    io.sockets.emit(&apos;system&apos;, nickname);//广播</div><div class="line">  &#125;);</div><div class="line">  socket.on(&apos;msg&apos;,function(data)&#123;//接收文本框中信息</div><div class="line">    console.log(data);</div><div class="line">    var sendMsg = &#123;&apos;name&apos;:socket.nickname,&apos;data&apos;:data&#125;</div><div class="line">    socket.broadcast.emit(&apos;chat&apos;,sendMsg);//广播</div><div class="line">  &#125;);</div><div class="line">  socket.on(&apos;disconnect&apos;,function()&#123;</div><div class="line">    io.sockets.emit(&apos;disconnect&apos;, socket.nickname);</div><div class="line">  &#125;)</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>总结：<br>本文对Socket.IO做了简单了解，若有不足或错误之处，还请多多指出。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/0720/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/0720/" itemprop="url">HTML5本地存储IndexedDB基础介绍（-）-数据库的简单增删改查</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-25T22:22:06+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####引用文档：<br><a href="http://www.cnblogs.com/dolphinX/p/3415761.html" target="_blank" rel="external">HTML5本地存储——IndexedDB（一：基本使用）</a></p>
<p><a href="http://www.cnblogs.com/dolphinX/p/3416889.html" target="_blank" rel="external">HTML5本地存储——IndexedDB（二：索引）</a></p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API" target="_blank" rel="external">IndexedDB API</a></p>
<p>JavaScript高级程序设计（第三版）</p>
<p>####Demo图示：<br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160923/5.png" alt=""></p>
<p>####IndexedDB简介：</p>
<blockquote>
<p>IndexedDB是在浏览器中保存结构化数据的一种数据库，IndexedDB的思想是创建一套API，方便保存和读取JavaScript对象，同时支持查询和搜索。IndexedDB的最大特色是使用对象保存数据。一个IndexedDB数据库，就是一组位于相同命名空间下的对象的集合。</p>
<p>####IndexedDB打开数据库：</p>
<ul>
<li><strong>open</strong></li>
</ul>
</blockquote>
<p>   IndexedDB是一个作为API宿主的全局对象,由于IndexedDB设计的操作为异步进行，所以大多数的操作为请求操作，打开数据库即向数据库发送<code>open</code>请求,如下代码所示，发送请求后，如果数据库存在，就打开该数据库，如果数据库不存在，就创建并打开该数据库，打开该数据库成功后会返回一个<code>IDBOpenDBRequest</code>对象，这个对象上可以添加一系列的处理程序，如代码中的<code>onerror</code>事件和<code>onsuccess</code>事件,在<code>onsuccess</code>中可以得到<code>IDBDatabase</code>对象。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;</div><div class="line">var request,database;</div><div class="line">request = indexedDB.open(&apos;test&apos;);</div><div class="line">request.onerror = function(e)&#123;</div><div class="line">    console.log(e.target.errorCode);</div><div class="line">&#125;;</div><div class="line">request.onsuccess = function(e)&#123;</div><div class="line">    database = e.target.result;</div><div class="line">    console.log(&apos;创建或打开数据库成功&apos;) ;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>   以上代码在控制台中得到结果如下图所示：<br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160922/1.png" alt=""></p>
<ul>
<li><p><strong>version</strong></p>
<p>默认情况下，IndexedDB是没有版本号的，最好一开始为数据库指定一个版本号，我们可以在创建或者打开数据库时为其指定版本号，在上述代码中将open函数传入的参数更改为<code>request = indexedDB.open(&#39;test&#39;,1);</code>这样就为当前数据库设定了版本号，通过设置版本号可以知道想使用的数据库是否设置了合适的对象存储空间，在整个Web应用中，随着数据库的更新和修改，可能会产生很多个不同的版本号（ps：关于版本号的用途也没有摸索特别清楚，可以确定的是每次增加对象存储空间都是要修改版本号的。）<br>####IndexedDB对象存储空间:<br>在建立或者打开数据库后，我们一般的操作是建立表，向表中插入数据，在IndexedDB中，用对象存储空间<code>ObjectStore</code>来代替表的概念，存储空间中的对象就相当于表中插入的数据。在上一步打开数据库的<code>onsuccess</code>中我们可以获得到<code>IDBDatabase</code>对象，创建存储空间就是在通过该对象调用<code>createObjectStore</code>函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var store = database.createObjectStore(&quot;students&quot;,&#123;keyPath:&quot;id&quot;&#125;);</div><div class="line">//var store = database.createObjectStore(&quot;students&quot;,&#123;autoIncrement:true&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>上述代码中<code>createObjectStore</code>第一个参数为存储对象空间的名字，第二个参数为存储空间的键，既数据库表中的主键，我们进行查找或者删除某个对象都要通过这个键来查找，如果不设置存储空间的键，可以如代码注释行一样，设置自增类型。<br>API文档中对于该参数说明如下：<br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160922/2.png" alt=""><br>在浏览器中显示如下：<br><img src="http://n.sinaimg.cn/mobileh5/01345b8f/20160922/3.png" alt=""></p>
<ul>
<li><strong>错误说明</strong></li>
</ul>
<p>在创建存储对象空间可能报如下错误：<br><code>Failed to execute &#39;createObjectStore&#39; on &#39;IDBDatabase&#39;: The database is not running a version change transaction.</code>报该错误的原因是：第一次<code>open</code>的<code>success</code>事件处于<code>version_change</code>事务中  这个时候不能<code>createObjectStore</code>，<code>createObjectStore</code>操作要在<code>onupgradeneeded</code>的事件中执行。</p>
<p>####为对象存储空间添加数据：<br>创建存储空间之后，可以用add()或者put()方法为其添加数据，这两个方法都接收所要保存的对象，区别之处在于，使用add()方法，遇到键值相同的对象会返回错误，而put()则不会报错，会重写原有对象。如下代码使用add()方法进行数据添加，代码中包括打开数据库及创建存储对象空间。可在控制台中直接运行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;</div><div class="line">var request,database;</div><div class="line">var data=[&#123; </div><div class="line">    id:1007, </div><div class="line">    name:&quot;Byron&quot;, </div><div class="line">    age:24 </div><div class="line">&#125;,&#123; </div><div class="line">    id:1008, </div><div class="line">    name:&quot;Frank&quot;, </div><div class="line">    age:30 </div><div class="line">&#125;,&#123; </div><div class="line">    id:1009, </div><div class="line">    name:&quot;Aaron&quot;, </div><div class="line">    age:26 </div><div class="line">&#125;];</div><div class="line">request = indexedDB.open(&apos;test&apos;,1);</div><div class="line">request.onerror = function()&#123;</div><div class="line">    console.log(&apos;error&apos;);</div><div class="line">&#125;;</div><div class="line">request.onsuccess = function(e)&#123;</div><div class="line">    database = e.target.result;	</div><div class="line">    console.log(&apos;创建或打开数据库成功&apos;) ;</div><div class="line">&#125;;</div><div class="line">request.onupgradeneeded=function(e)&#123;</div><div class="line">	database = e.target.result;</div><div class="line">	</div><div class="line">    if(!database.objectStoreNames.contains(&quot;students&quot;))&#123;</div><div class="line">    	var store = database.createObjectStore(&quot;students&quot;,&#123;autoIncrement:true&#125;);</div><div class="line">		for(var i = 0 ; i &lt; data.length;i++)&#123;</div><div class="line">		    request = store.add(data[i]);</div><div class="line">		    request.onerror = function()&#123;</div><div class="line">			 console.error(&apos;数据库中已有该数据&apos;)</div><div class="line">		    &#125;;</div><div class="line">		    request.onsuccess = function()&#123;</div><div class="line">			 console.log(&apos;数据已存入数据库&apos;)</div><div class="line">		    &#125;;</div><div class="line">		&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>####事务<br>创建对象存储空间之后，数据库中的增删改查都是通过事务<code>transaction</code>来完成的，在数据库对象上调用<code>transaction()</code>方法可以创建事务。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var transaction= database.transaction(&quot;students&quot;,&apos;readwrite&apos;);</div><div class="line">var store = transaction.objectStore(&quot;students&quot;)</div></pre></td></tr></table></figure></p>
<p>如上代码保证只加载<code>students</code>存储空间的数据，然后通过事务访问该空间，对该空间中的数据进行操作，transaction()中传入的第二个参数为对该空间操作的方式，默认为<code>readonly</code>只读操作，代码中传入的是<code>readwrite</code>读写操作。其它可访问MDN API<a href="https://developer.mozilla.org/en-US/docs/Web/API/IDBTransaction" target="_blank" rel="external">IDBTransaction</a>;</p>
<p>####完整代码<br>下述代码为demo中的代码，整合数据库的增删改查，包括添加查找删除数据，创建打开关闭数据库，由于异步操作，在调用<code>open</code>之后需要等返回<code>success</code>函数中执行其它操作，或者设立<code>setTimeout</code>定时器，执行结果如demo图示所示。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div></pre></td><td class="code"><pre><div class="line">var myDB=&#123;</div><div class="line">        name:&apos;school&apos;,</div><div class="line">        version:1,</div><div class="line">        db:null,</div><div class="line">        ojstore:&#123;</div><div class="line">        	name:&apos;students&apos;,//存储空间表的名字</div><div class="line">        	keypath:&apos;id&apos;//主键</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">	var INDEXDB = &#123;</div><div class="line">		indexedDB:window.indexedDB||window.webkitindexedDB,</div><div class="line">		IDBKeyRange:window.IDBKeyRange || window.webkitIDBKeyRange,//键范围</div><div class="line">		openDB:function(dbname,dbversion,callback)&#123;</div><div class="line">			//建立或打开数据库，建立对象存储空间(ObjectStore)</div><div class="line">			var self = this;</div><div class="line">			var	version = dbversion || 1;</div><div class="line">			var request = self.indexedDB.open(dbname,version);</div><div class="line">			request.onerror = function(e)&#123;</div><div class="line">				console.log(e.currentTarget.error.message);</div><div class="line">			&#125;;</div><div class="line">			request.onsuccess = function(e)&#123;</div><div class="line">				myDB.db = e.target.result;</div><div class="line">				console.log(&apos;成功建立并打开数据库:&apos;+myDB.name+&apos; version&apos;+dbversion);</div><div class="line">			&#125;;</div><div class="line">			request.onupgradeneeded=function(e)&#123;</div><div class="line">				var db=e.target.result,transaction= e.target.transaction,store;</div><div class="line">				if(!db.objectStoreNames.contains(myDB.ojstore.name))&#123;</div><div class="line">					//没有该对象空间时创建该对象空间</div><div class="line">					store = db.createObjectStore(myDB.ojstore.name,&#123;keyPath:myDB.ojstore.keypath&#125;);</div><div class="line">					console.log(&apos;成功建立对象存储空间：&apos;+myDB.ojstore.name);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line"></div><div class="line">		&#125;,</div><div class="line">		deletedb:function(dbname)&#123;</div><div class="line">			//删除数据库</div><div class="line">			var self = this;</div><div class="line">			self.indexedDB.deleteDatabase(dbname);</div><div class="line">			console.log(dbname+&apos;数据库已删除&apos;)</div><div class="line">		&#125;,</div><div class="line">		closeDB:function(db)&#123;</div><div class="line">			//关闭数据库</div><div class="line">			db.close();</div><div class="line">			console.log(&apos;数据库已关闭&apos;)</div><div class="line">		&#125;,</div><div class="line">		addData:function(db,storename,data)&#123;</div><div class="line">			//添加数据，重复添加会报错</div><div class="line">			var store = store = db.transaction(storename,&apos;readwrite&apos;).objectStore(storename),request;</div><div class="line">			for(var i = 0 ; i &lt; data.length;i++)&#123;</div><div class="line">	    		request = store.add(data[i]);</div><div class="line">	    		request.onerror = function()&#123;</div><div class="line">	    			console.error(&apos;add添加数据库中已有该数据&apos;)</div><div class="line">	    		&#125;;</div><div class="line">	    		request.onsuccess = function()&#123;</div><div class="line">	    			console.log(&apos;add添加数据已存入数据库&apos;)</div><div class="line">	    		&#125;;</div><div class="line">	    	&#125;</div><div class="line">	    	</div><div class="line">		&#125;,</div><div class="line">		putData:function(db,storename,data)&#123;</div><div class="line">			//添加数据，重复添加会更新原有数据</div><div class="line">			var store = store = db.transaction(storename,&apos;readwrite&apos;).objectStore(storename),request;</div><div class="line">			for(var i = 0 ; i &lt; data.length;i++)&#123;</div><div class="line">	    		request = store.put(data[i]);</div><div class="line">	    		request.onerror = function()&#123;</div><div class="line">	    			console.error(&apos;put添加数据库中已有该数据&apos;)</div><div class="line">	    		&#125;;</div><div class="line">	    		request.onsuccess = function()&#123;</div><div class="line">	    			console.log(&apos;put添加数据已存入数据库&apos;)</div><div class="line">	    		&#125;;</div><div class="line">	    	&#125;</div><div class="line">		&#125;,</div><div class="line">		getDataByKey:function(db,storename,key)&#123;</div><div class="line">			//根据存储空间的键找到对应数据</div><div class="line">			var store = db.transaction(storename,&apos;readwrite&apos;).objectStore(storename);</div><div class="line">			var request = store.get(key);</div><div class="line">			request.onerror = function()&#123;</div><div class="line">				console.error(&apos;getDataByKey error&apos;);</div><div class="line">			&#125;;</div><div class="line">			request.onsuccess = function(e)&#123;</div><div class="line">				var result = e.target.result;</div><div class="line">				console.log(&apos;查找数据成功&apos;)</div><div class="line">				console.log(result);</div><div class="line">			&#125;;</div><div class="line">		&#125;,</div><div class="line">		deleteData:function(db,storename,key)&#123;</div><div class="line">			//删除某一条记录</div><div class="line">			var store = store = db.transaction(storename,&apos;readwrite&apos;).objectStore(storename);</div><div class="line">			store.delete(key)</div><div class="line">			console.log(&apos;已删除存储空间&apos;+storename+&apos;中&apos;+key+&apos;记录&apos;);</div><div class="line">		&#125;,</div><div class="line">		clearData:function(db,storename)&#123;</div><div class="line">			//删除存储空间全部记录</div><div class="line">			var store = db.transaction(storename,&apos;readwrite&apos;).objectStore(storename);</div><div class="line">			store.clear();</div><div class="line">			console.log(&apos;已删除存储空间&apos;+storename+&apos;全部记录&apos;);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	var students=[&#123; </div><div class="line">        id:1001, </div><div class="line">        name:&quot;Byron&quot;, </div><div class="line">        age:24 </div><div class="line">    &#125;,&#123; </div><div class="line">        id:1002, </div><div class="line">        name:&quot;Frank&quot;, </div><div class="line">        age:30 </div><div class="line">    &#125;,&#123; </div><div class="line">        id:1003, </div><div class="line">        name:&quot;Aaron&quot;, </div><div class="line">        age:26 </div><div class="line">    &#125;];</div><div class="line"></div><div class="line">	INDEXDB.openDB(myDB.name,myDB.version);</div><div class="line">    setTimeout(function()&#123;</div><div class="line">    	// console.log(&apos;****************添加数据****************************&apos;);</div><div class="line">    	// INDEXDB.addData(myDB.db,myDB.ojstore.name,students);</div><div class="line">    	// console.log(&apos;******************add重复添加**************************&apos;);</div><div class="line">    	// INDEXDB.addData(myDB.db,myDB.ojstore.name,students);</div><div class="line">    	// console.log(&apos;*******************put重复添加*************************&apos;);</div><div class="line">    	// INDEXDB.putData(myDB.db,myDB.ojstore.name,students);</div><div class="line">    	// console.log(&apos;*******************获取数据1001*************************&apos;);</div><div class="line">    	// INDEXDB.getDataByKey(myDB.db,myDB.ojstore.name,1001);</div><div class="line">    	// console.log(&apos;******************删除数据1001************&apos;);</div><div class="line">    	// INDEXDB.deleteData(myDB.db,myDB.ojstore.name,1001);</div><div class="line">    	// console.log(&apos;******************删除全部数据************&apos;);</div><div class="line">    	// INDEXDB.clearData(myDB.db,myDB.ojstore.name);</div><div class="line">    	// console.log(&apos;******************关闭数据库************&apos;);</div><div class="line">    	// INDEXDB.closeDB(myDB.db);</div><div class="line">    	// console.log(&apos;******************删除数据库************&apos;);</div><div class="line">    	// INDEXDB.deletedb(myDB.db);</div><div class="line">    &#125;,800)</div></pre></td></tr></table></figure></p>
<p>下篇:<a href="http://fe.sina.cn/2016/09/23/html5ben-di-cun-chu-indexeddbji-chu-jie-shao-er-you-biao-he-suo-yin/" target="_blank" rel="external">HTML5本地存储IndexedDB基础介绍（二）- 游标和索引</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="John Doe" />
          <p class="site-author-name" itemprop="name">John Doe</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">Artikel</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">Kategorien</span>
              
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>


<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
